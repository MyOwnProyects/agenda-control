<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8f9fa;
    }

    .sidebar {
        width: 250px;
        transition: all 0.3s;
        background-color: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .sidebar.collapsed {
        width: 80px;
    }

    .sidebar .nav-link span.text {
        transition: opacity 0.3s;
    }

    .sidebar.collapsed .nav-link span.text {
        opacity: 0;
        visibility: hidden;
        width: 0;
    }

    .sidebar .nav-link {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 5px;
    }

    .sidebar .nav-link.active {
        background-color: #e7f1ff;
        color: #0d6efd !important;
    }

    .sidebar .material-symbols-outlined {
        font-size: 24px;
    }

    .sidebar .brand {
        font-weight: 700;
        font-size: 1.25rem;
    }

    .profile-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-size: cover;
        background-position: center;
        background-color: #e9ecef;
    }

    main {
        transition: margin-left 0.3s;
        min-height: 100vh;
    }

    .collapsed + main {
        margin-left: 80px !important;
    }

    .sidebar-toggler {
        border: none;
        background: none;
        color: #6c757d;
        padding: 8px;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .sidebar-toggler:hover {
        background-color: #e9ecef;
    }

    .card {
        border: none;
        border-radius: 12px;
    }

    .card-header {
        /* background-color: white; */
        border-bottom: 1px solid #e9ecef;
        border-radius: 12px 12px 0 0 !important;
    }

    .stats-card {
        transition: transform 0.2s;
        height: 100%;
    }

    .stats-card:hover {
        transform: translateY(-5px);
    }

    /* Altura fija para las tarjetas de estadísticas */
    .fixed-height-card {
        height: 100px;
    }

    /* El contenedor de próximas citas puede crecer libremente */
    .appointments-card {
        height: auto;
        min-height: 100px;
    }

    .appointment-item {
        border-bottom: 1px solid #e9ecef;
    }

    .chart-container {
        position: relative;
        height: 300px;
        padding: 15px;
    }

    .hide {
        display:none!important;
    }

    #div_header_citas_diarias {
      max-height: 50vh;         /* No excede la mitad de la pantalla */
      overflow-y: auto;          /* Activa el scroll vertical solo si lo necesita */
      scrollbar-width: thin;     /* Scroll discreto (Firefox) */
      scrollbar-color: #adb5bd transparent;
    }

    /* Estilo opcional para navegadores WebKit (Chrome, Edge, Safari) */
    #div_header_citas_diarias::-webkit-scrollbar {
      width: 6px;
    }
    #div_header_citas_diarias::-webkit-scrollbar-thumb {
      background-color: #adb5bd;
      border-radius: 3px;
    }

</style>

<div class="d-flex">
    <!-- Main content -->
    <main class="flex-grow-1 p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold">¡Hola <?php echo $nombre_usuario; ?>!</h2>
                <p class="text-muted">Aquí tienes un resumen del día.</p>
            </div>
            <div class="text-end">
                <p id="fecha_actual_label" class="text-muted mb-0 small"><?php echo $fecha_actual_label ?></p>
                <p id="hora_actual" class="fw-bold mb-0"><?php echo $hora_bd ?></p>
            </div>
        </div>
        <?php if ($pacientes || $agenda): ?>
        <div class="row g-3 mb-4">
            <!-- Columna izquierda: Stats + Gráfica -->
            <div class="col-md-12">
                <div class="d-flex justify-content-end gap-2">
                    <?php if ($pacientes): ?>
                    <a href="/Pacientes" class="btn btn-outline-primary d-flex align-items-center">
                        <i class="bi bi-search"></i>Ver Pacientes
                    </a>
                    <?php endif; ?>
                    <?php if ($agenda): ?>
                    <a href="/Agenda" class="btn btn-primary d-flex align-items-center">
                      <i class="bi bi-plus-lg me-1"></i>Programar Cita
                    </a>
                    <?php endif; ?>
                    <button id="actualizar_registros" class="btn btn-primary d-flex align-items-center">
                      <i class="bi bi-arrow-clockwise"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
        <?php endif; ?>

        <!-- Stats y Citas Próximas -->
        <div class="row g-3 mb-4">
            <!-- Columna izquierda: Stats + Gráfica -->
            <div class="col-md-8">
                <!-- Stats -->
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <div class="card shadow-sm stats-card fixed-height-card">
                            <div class="card-body">
                                <p class="text-muted mb-1">Pendientes Hoy</p>
                                <h3 id="citas_pendientes" class="fw-bold mb-1">12</h3>
                                <small id="pendientes_porcentaje" class="text-success">+5% desde ayer</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm stats-card fixed-height-card">
                            <div class="card-body">
                                <p class="text-muted mb-1">Completadas Hoy</p>
                                <h3 id="citas_completadas" class="fw-bold mb-1">8</h3>
                                <small id="completadas_porcentaje" class="text-success">-2% desde ayer</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm stats-card fixed-height-card">
                            <div class="card-body">
                                <p class="text-muted mb-1">Canceladas Hoy</p>
                                <h3 id="citas_canceladas" class="fw-bold mb-1">2</h3>
                                <small id="canceladas_porcentaje" class="text-danger">+1% desde ayer</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm stats-card fixed-height-card">
                            <div class="card-body">
                                <p class="text-muted mb-1">En curso</p>
                                <h3 id="citas_en_curso" class="fw-bold mb-1">0</h3>
                                <small id="texto_citas_en_curso" class="text-success">En proceso...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfica de Citas -->
                <div class="row g-3 mt-3">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center" style="background-color: white;">
                                <h5 class="mb-0">Citas de esta Semana</h5>
                                <!-- <a href="#" class="text-primary text-decoration-none small">Ver Detalles</a> -->
                            </div>
                            <div class="card-body p-3">
                                <div class="mb-2">
                                    <h2 id="citas_activas_totales" class="fw-bold mb-0"></h2>
                                    <small class="text-muted">Citas activas de la semana del <?php echo $fecha_inicio_semana.' al '.$fecha_termino_semana; ?></small>
                                </div>
                                <div class="chart-container">
                                    <canvas id="div_chart" height="100"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: Próximas Citas -->
            <div class="col-md-4">
                <div class="card shadow-sm appointments-card" style="background-color: #ffb30063!important;">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <h6 class="mb-0">Citas en curso</h6>
                    </div>
                    <div id="div_header_citas_en_curso" class="card-body p-2">
                        
                    </div>
                </div>
                <div class="card shadow-sm appointments-card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center py-2" style="background-color: white;">
                        <h6 class="mb-0">Próximas Citas</h6>
                        <?php if ($agenda): ?>
                        <a href="/Agenda" class="text-primary text-decoration-none small">Ir a agenda</a>
                        <?php endif; ?>
                    </div>
                    <div id="div_header_citas_diarias" class="card-body p-2">
                        
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="template_cita_diaria" class="appointment-item d-flex align-items-center py-2 hide">
    <div class="profile-img me-2 d-flex align-items-center justify-content-center bg-light text-secondary border rounded-circle"
    style="width: 32px; height: 32px; background-size: cover; background-position: center;">
        <i class="bi bi-person-fill"></i>
    </div>


  <div class="flex-fill">
    <p class="mb-0 fw-medium small nombre_completo"></p>
    <small class="text-muted hora_servicios" style="font-size: 0.75rem;"></small>
  </div>

  <!-- Dropdown -->
  <?php if ($expediente_digital || $expediente_clinico): ?>
  <div class="dropdown">
    <button class="btn btn-sm btn-light p-1" data-bs-toggle="dropdown">
      <i class="bi bi-three-dots-vertical"></i>
    </button>
    <ul class="dropdown-menu dropdown-menu-end py-1">
      <?php if ($expediente_digital): ?>
      <li>
        <button type="button" class="dropdown-item option_expediente" data-location="/Pacientes/digitalRecord">
          Ver expediente
        </button>
      </li>
      <?php endif; ?>

      <?php if ($expediente_clinico): ?>
      <li>
        <button type="button" class="dropdown-item option_clinical" data-location="/Pacientes/clinicalData">
          Captura de datos clínicos
        </button>
      </li>
      <?php endif; ?>
    </ul>
  </div>
  <?php endif; ?>
</div>



<div id="template_sin_citas" class="text-center py-4 hide">
    <i class="bi bi-inbox" style="font-size: 2.5rem; color: #e9ecef;"></i>
    <p class="text-muted mt-3 mb-0 mensaje">No hay más citas pendientes</p>
</div>

<script>
    var module_dashboard = (function(){

        //  RUTAS
        const controller  = '/Menu';
        const url_index   = controller+"/index";

        //  CHART JS
        let chart_js  = null;

        //  OBJ DE DIAS PARA PINTAR GRAFICA
        let obj_data_dias = {
            'Lun' : 0,
            'Mar' : 0,
            'Mie' : 0,
            'Jue' : 0,
            'Vie' : 0,
            'Sab' : 0,
            'Dom' : 0,
        }

        const dia_semana  = '<?php echo $dia_semana; ?>';

        let obj_dias    = ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'];
        let obj_colores = [
                                dia_semana == 'lunes' ? '#0d6efd' : '#cfe2ff', 
                                dia_semana == 'martes' ? '#0d6efd' : '#cfe2ff', 
                                dia_semana == 'miércoles' ? '#0d6efd' : '#cfe2ff', 
                                dia_semana == 'jueves' ? '#0d6efd' : '#cfe2ff', 
                                dia_semana == 'viernes' ? '#0d6efd' : '#cfe2ff', 
                                dia_semana == 'sábado' ? '#0d6efd' : '#cfe2ff', 
                                dia_semana == 'domingo' ? '#0d6efd' : '#cfe2ff', 
                            ];

        //  PARAMETROS PARA OBTENER FECHA Y HORA DEL SERVER
        let fecha_actual  = '<?php echo $fecha_actual; ?>';
        let hora_actual   = '<?php echo $hora_bd; ?>';
        console.log('hora_actual',hora_actual);

        //  OBJ CARGA INICIAL
        let data_dashboard = '<?php echo $json_data_citas; ?>';
        data_dashboard = JSON.parse(data_dashboard);

        $(document).ready(function(){
            console.log('data_dashboard',data_dashboard);
            
            //  SE INICIA LA HORA
            let hora = moment(hora_actual, 'HH:mm:ss');
            setInterval(function() {
                hora.add(1, 'second');
                $("#hora_actual").text(hora.format('HH:mm:ss'));

                // Obtener los minutos actuales
                const minutos = hora.minutes();

                // Verificar si es múltiplo de 5 y los segundos son 0
                if (minutos % 5 === 0 && hora.seconds() === 0) {
                    $("#actualizar_registros").trigger('click');
                }

            }, 1000);


            $(document).on('click',".dropdown-item",function(){
              //console.log('url',$(this).data('location') +'?id_agenda_cita='+$(this).data('idagendacita'));
              window.location.href = $(this).data('location') +'?id_agenda_cita='+$(this).data('idagendacita');
            });

            $("#actualizar_registros").on('click',function(){
              let btn = $(this);
              $(btn).prop('disabled',true);
              $.ajax({
                url     : url_index,
                method  : 'post',
                data    : {
                  accion  : 'actualizar_datos'
                },
                success   : function(data){
                  console.log('new data',data_dashboard);
                  data_dashboard  = [];
                  data_dashboard  = data['citas'];
                  $("#fecha_actual_label").text(data['fecha_actual_label']);
                  show_chart();
                  $(btn).prop('disabled',false);
                },
                error   : function(error){
                  actionJsonError(error,btn);
                }
              })
            });

            show_chart();
        });

        function show_chart(){
            let citas_canceladas    = 0;
            let citas_pendientes    = 0;
            let citas_completadas   = 0;
            let citas_en_curso      = 0;
            let citas_dia           = 0;
            let citas_totales       = 0;

            $("#div_header_citas_en_curso").html('');
            $("#div_header_citas_diarias").html('');

            data_dashboard.forEach(item => {
                //  PARA SABER SI LA CITA ES DE HOY
                if (item.fecha_cita == fecha_actual){
                    citas_dia ++;
                    //  CITA ACTIVA
                    if (item.activa == 1){
                        // hora_actual es tipo 'HH:mm:ss'
                        const hora_actual         = $("#hora_actual").text();
                        const hora_actual_moment  = moment(hora_actual, 'HH:mm:ss');
                        const hora_inicio_moment  = moment(item.hora_inicio, 'HH:mm:ss');
                        const hora_termino_moment   = moment(item.hora_termino, 'HH:mm:ss');
                        
                        //  CITAS PENDIENTES, SE AUMENTA EL COUNT Y SE GENERA EL TEMPLATE
                        if (hora_actual_moment.isBefore(hora_inicio_moment)){
                            citas_pendientes++;

                            let row_clone = $("#template_cita_diaria").clone().removeAttr('id').removeClass('hide').show();

                            $(row_clone).find('.dropdown-item').data('idagendacita',item.id_agenda_cita);

                            //  SE BUSCAN LSO SERVICIOS
                            let servicios = item.servicios;
                            let first_row = true;
                            let label_servicio  = '';
                            for(let i in servicios){
                              if (!first_row){
                                label_servicio  += '/';
                              }

                              label_servicio  += servicios[i]['nombre_servicio'];
                            }

                            $(row_clone).find('.nombre_completo').text(item.nombre_completo);
                            $(row_clone).find('.hora_servicios').text(item.hora_inicio + ' hrs. - '+label_servicio);

                            $("#div_header_citas_diarias").append(row_clone);
                        }

                        //  SI LA HORA INICIO ESTA DENTRO DEL RANGO ES UNA CITA ACTIVA
                        //  [) INDICA QUE SE CONSIDERA DENTRO DEL RANGO SI HORA_ACTUAL ES IGUAL  O MAYOR QUE HORA_INICIO
                        //  Y MENOR QUE HORA TERMINO
                        if (hora_actual_moment.isBetween(hora_inicio_moment, hora_termino_moment, undefined, '[)')){
                            citas_en_curso  ++;

                            let row_clone = $("#template_cita_diaria").clone().removeAttr('id').removeClass('hide').show();

                            $(row_clone).find('.dropdown-item').data('idagendacita',item.id_agenda_cita);

                            //  SE BUSCAN LSO SERVICIOS
                            let servicios = item.servicios;
                            let first_row = true;
                            let label_servicio  = '';
                            for(let i in servicios){
                              if (!first_row){
                                label_servicio  += '/';
                              }

                              label_servicio  += servicios[i]['nombre_servicio'];
                            }

                            $(row_clone).find('.nombre_completo').text(item.nombre_completo);
                            $(row_clone).find('.hora_servicios').text(item.hora_inicio + ' hrs. - '+label_servicio);

                            $(row_clone).find('.btn-light').removeClass('btn-light');

                            $("#div_header_citas_en_curso").append(row_clone);
                        }

                        //  HORA ACTUAL PASO DE LA HORA DE TERMINO
                        if (hora_actual_moment.isAfter(hora_termino_moment) || hora_actual_moment.isSame(hora_termino_moment)){
                            citas_completadas++;
                        }
                    }
                    if (item.activa == 0){
                        citas_canceladas++;
                    }
                }

                if (item.activa == 1){
                    citas_totales ++;

                    obj_data_dias[obj_dias[item.dia - 1]] ++;
                }
            });

            // Calcular porcentajes
            const porcentaje_completadas  = citas_dia > 0 ? Math.round((citas_completadas / citas_dia) * 100) : 0;
            const porcentaje_canceladas   = citas_dia > 0 ? Math.round((citas_canceladas / citas_dia) * 100) : 0;

            // Texto de progreso para pendientes
            const texto_pendientes = citas_pendientes === 0 
                ? "¡Todo listo! ✓" 
                : `${citas_completadas + citas_en_curso} de ${citas_dia} atendidas`;

            //  SI NO HAY CITAS PENDIENTES
            if (citas_pendientes == 0){
                let row_vacio = $("#template_sin_citas").clone().removeAttr('id').removeClass('hide');
                $("#div_header_citas_diarias").html('').append(row_vacio);
            }

            //  NO HAY CITAS EN CURSO
            if (citas_en_curso == 0){
                let row_vacio = $("#template_sin_citas").clone().removeAttr('id').removeClass('hide');
                //  bi-inbox
                $(row_vacio).find('.bi-inbox').css('color','black');
                $(row_vacio).find('.mensaje').text('No hay citas en curso');
                $("#div_header_citas_en_curso").html('').append(row_vacio);
            }

            //  MOSTRAR COUNT
            $("#citas_canceladas").text(citas_canceladas);
            $("#citas_pendientes").text(citas_pendientes);
            $("#citas_completadas").text(citas_completadas);
            $("#citas_activas_totales").text(citas_totales);
            $("#citas_en_curso").text(citas_en_curso);
            
            // MOSTRAR PORCENTAJES Y PROGRESO
            $("#pendientes_porcentaje").text(texto_pendientes);
            $("#completadas_porcentaje").text(`${porcentaje_completadas}% del día`);
            $("#canceladas_porcentaje").text(porcentaje_canceladas == 0 ? 'Sin registros' :`${porcentaje_canceladas}% del día`);
            $("#texto_citas_en_curso").text(citas_en_curso == 0 ? 'Sin citas en curso' : 'Citas en curso...');
            // Opcional: Cambiar color cuando todo está listo
            if (citas_pendientes === 0 && citas_dia > 0) {
                $("#pendientes_porcentaje").removeClass("text-primary").addClass("text-success");
            } else {
                $("#pendientes_porcentaje").removeClass("text-success").addClass("text-primary");
            }

            // Manejar caso de sin citas hoy
            if (citas_dia === 0) {
                $("#porcentaje_proximas").text("Sin citas hoy").removeClass("text-primary text-success").addClass("text-muted");
                $("#completadas_porcentaje").text("Sin citas hoy").removeClass("text-success").addClass("text-muted");
                $("#canceladas_porcentaje").text("Sin citas hoy").removeClass("text-danger").addClass("text-muted");
            }


            // Chart.js implementation
            const ctx = $("#div_chart");

            // Si ya existe una gráfica, destruirla antes de crear otra
            if (chart_js) {
                chart_js.destroy();
            }

            chart_js  = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: obj_dias,
                    datasets: [
                        {
                            label: 'Citas',
                            data: obj_data_dias,
                            backgroundColor: obj_colores,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#0d6efd',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    return `Citas: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            display: false,
                            beginAtZero: true
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12,
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                }
            });
        }
        
    })();
</script>