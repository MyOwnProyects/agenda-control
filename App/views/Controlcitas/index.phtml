<?php 
use App\Library\FuncionesGlobales;
?>
<style>
    .list-group-item {
      border: none; /* Elimina los bordes */
      cursor: pointer; /* Cambia el cursor al pasar por el div padre */
    }

    .hide{
        display: none;
    }

    .div_label_accion {
        margin-bottom: 5px; /* Reduce el espacio vertical entre los elementos */
        padding: 0; /* Opcional: elimina el relleno interno si es necesario */
    }

    .div_check {
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da; /* Color del borde */
        border-radius: 0.375rem; /* Bordes redondeados */
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        max-width: calc(100% - 1px); /* Reduce el ancho en 1px */
        cursor: pointer;
    }

    .hide {
        display:none;
    }

    /* ESTILO PARA MODAL DE INFORMACION */
/* Encabezado del modal */
#modal_info_cita .modal-header {
  background-color: #343a40;
  color: #fff;
  border-bottom: 1px solid #dee2e6;
  border-top-left-radius: 0.75rem;
  border-top-right-radius: 0.75rem;
}

/* Labels dentro del body */
#modal_info_cita .modal-body label {
  font-weight: 600;
  color: #495057;
}

/* Spans dentro del body */
#modal_info_cita .modal-body span {
  display: inline-block;
  margin-top: 0.25rem;
  font-weight: 500;
  color: #212529;
}

/* Separadores de secciones */
#modal_info_cita .row.mb-3 {
  padding: 10px 0;
  border-bottom: 1px dashed #ced4da;
  margin-bottom: 15px;
}

/* Información de cancelación */
#modal_info_cita .div_info_cancelacion {
  background-color: #fff3cd;
  border: 1px solid #ffeeba;
  padding: 15px;
  border-radius: 0.5rem;
  margin-top: 15px;
}

#modal_info_cita .div_info_cancelacion label {
  font-weight: bold;
  color: #856404;
  margin-bottom: 10px;
}

/* Lista de servicios */
#modal_info_cita .div_servicios {
  /*background-color: #f1f3f5;  Fondo uniforme para toda la sección */
  border: 1px solid #ced4da;
  padding: 15px;
  border-radius: 0.5rem;
  margin-top: 20px;
}

#modal_info_cita .div_servicios label {
  font-weight: bold;
  margin-bottom: 10px;
  display: block;
  color: #495057;
}

#modal_info_cita .div_servicios .d-flex {
  align-items: center;
}

/* Quitamos el fondo de las filas de encabezado de servicios */
#modal_info_cita .div_servicios .div_header_servicios .d-flex {
  background-color: transparent;
}

/* Total en servicios */
#modal_info_cita .div_servicios .total {
  font-size: 1.1rem;
  color: #343a40;
}

/* Footer del modal */
#modal_info_cita .modal-footer {
  border-top: none;
}

/* Botón de cancelar */
#modal_info_cita .btn-outline-dark {
  border-radius: 0.5rem;
  padding: 6px 20px;
}

</style>

<div class="container mt-4">
    <!-- Section 1: Search Filters -->
    <div id="header_filters" class="card mb-4">
        <div class="card-header">
            <h5><?php echo $translations['html_header_search']; ?></h5>
        </div>
        <div class="card-body">
            <form id="searchForm" class="row g-3">
                <div class="col-md-4">
                    <label for="select_locaciones" class="form-label"><?php echo $translations['html_locations']; ?></label>
                    <?php $count_locaciones = count($arr_locaciones); ?>
                    <select id="select_locaciones" class="select_locaciones" <?php echo $count_locaciones == 1 ? 'disabled' : ''; ?>>
                        <option value=""></option>
                        <?php foreach($arr_locaciones as $locacion): ?>
                            <option value="<?php echo $locacion['id']; ?>" <?php echo $count_locaciones == 1 ? 'selected' : ''; ?>><?php echo $locacion['nombre']; ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="select_profesionales" class="form-label"><?php echo $translations['html_title_professionals']; ?></label>
                    <select id="select_profesionales" class="select_profesionales">
                        <option value=""></option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="nameFilter" class="form-label"><?php echo $translations['html_title_patients']; ?></label>
                    <select id="select_pacientes" class="select_pacientes">
                        <option value=""></option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="input_rango_fecha_inicio" class="form-label"><?php echo $translations['html_appointment_date']; ?></label>
                    <input type="date" class="form-control" id="input_rango_fecha_inicio" name="input_rango_fecha_inicio" placeholder="<?php echo $translations['html_appointment_date']; ?>">
                </div>
                <div class="col-md-4">
                    <label for="rango_fecha_termino" class="form-label"><?php echo $translations['html_limit_date']; ?></label>
                    <input type="date" class="form-control" id="input_rango_fecha_termino" name="input_rango_fecha_termino" placeholder="<?php echo $translations['html_limit_date']; ?>">
                </div>
                <div class="col-md-4">
                    
                </div>
                <div class="col-md-4">
                    <label class="form-label"><b><?php echo $translations['html_filter_appoitments']; ?></b></label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filtro_citas" id="radio_todas" value="todas" checked>
                        <label class="form-check-label" for="radio_todas">
                            <?php echo $translations['html_all_appoitments']; ?>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filtro_citas" id="radio_activas" value="activas">
                        <label class="form-check-label" for="radio_activas">
                            <?php echo $translations['html_active_appoitments']; ?>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filtro_citas" id="radio_canceladas" value="canceladas">
                        <label class="form-check-label" for="radio_canceladas">
                            <?php echo $translations['html_canceled_appoitments']; ?>
                        </label>
                    </div>
                </div>

                <div class="col-md-12 text-end">
                    <button type="button" class="btn btn-outline-dark" id="btnBuscar">
                        <i class="bi bi-search"></i> 
                        <?php echo $translations['html_btn_search']; ?>
                    </button>
                    <button type="button" class="btn btn-outline-dark" id="btn_agenda_opening">
                        <i class="bi bi-calendar-date"></i>
                        <?php echo $translations['html_agenda_opening']; ?>
                    </button>
                </div> 
            </form>
        </div>
    </div>

    <!-- Section 2: Data Table -->
    <div class="card">
        <div class="card-header">
            <h5><?php echo $translations['html_header_results']; ?></h5>
        </div>
        <div class="card-body">
            <table id="table_results" class="display table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th><?php echo $translations['html_title_patient']; ?></th>
                        <th><?php echo $translations['html_title_professional']; ?></th>
                        <th><?php echo $translations['html_assigned_services']; ?></th>
                        <th><?php echo $translations['html_appointment_date']; ?></th>
                        <th><?php echo $translations['html_appointment_time']; ?></th>
                        <th><?php echo $translations['html_current_status']; ?></th>
                        <th><?php echo $translations['html_action']; ?></th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_agenda_opening" tabindex="-1" aria-labelledby="label_modal_agenda_opening" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="label_modal_agenda_opening"><?php echo FuncionesGlobales::UpperString($translations['html_agenda_opening']); ?></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body col-md-12">
        <form id="form_modal_agenda_opening" class="needs-validation" novalidate>
            <div class="row mb-3">
                <!-- Campo Clave -->
                <div class="col-md-6">
                    <label for="input_clave" class="col-form-label"><?php echo $translations['html_location']; ?></label>
                    <?php $count_locaciones = count($arr_locaciones); ?>
                    <select id="select_locaciones_modal" class="select_locaciones_modal" <?php echo $count_locaciones == 1 ? 'disabled' : ''; ?> required>
                        <option value=""></option>
                        <?php foreach($arr_locaciones as $locacion): ?>
                            <option value="<?php echo $locacion['id']; ?>" <?php echo $count_locaciones == 1 ? 'selected' : ''; ?>><?php echo $locacion['nombre']; ?></option>
                        <?php endforeach; ?>
                    </select>
                    <div class="invalid-feedback"><?php echo $translations['html_error_selected_location']; ?></div>
                </div>
                <div class="col-md-6">
                    <label for="input_fecha_inicio" class="col-form-label"><?php echo $translations['html_starting_date']; ?></label>
                    <input type="date" class="form-control" id="input_fecha_inicio" disabled required>
                    <div class="invalid-feedback"><?php echo $translations['html_error_starting_date']; ?></div>
                </div>
                <div class="col-md-6">
                    <label for="input_fecha_termino" class="col-form-label"><?php echo $translations['html_limit_date']; ?></label>
                    <input type="date" class="form-control" id="input_fecha_termino" disabled required>
                    <div class="invalid-feedback"><?php echo $translations['html_error_starting_date']; ?></div>
                </div>
            </div>
            <div id="alert_error" class="alert alert-danger align-items-center" role="alert" style="display:none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img" aria-label="Warning:">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                <div id="msg_error">
                    
                </div>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal"><?php echo $translations['html_btn_cancel']; ?></button>
        <button type="button" id="btnSave" class="btn btn-primary"><?php echo $translations['html_btn_save']; ?></button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal_cancelar_cita" tabindex="-1" aria-labelledby="label_modal_agenda_opening" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="label_modal_cancelar_cita"><?php echo FuncionesGlobales::UpperString($translations['html_cancel_appointment']); ?></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body col-md-12">
        <form id="form_modal_cancelar_cita" class="needs-validation" novalidate>
            <div class="row mb-3">
                <!-- Campo Clave -->
                <div class="col-md-12">
                    <label for="input_clave" class="col-form-label"><?php echo $translations['html_reason_cancellation']; ?></label>
                    <select id="select_motivo_cancelacion">
                        <option></option>
                        <?php foreach($motivos_cancelacion_cita as $motivo): ?>
                            <option value="<?php echo $motivo['id']; ?>"><?php echo $motivo['nombre']; ?></option>
                        <?php  endforeach; ?>
                    </select>
                    <div class="invalid-feedback"><?php echo $translations['html_error_reason_cancellation']; ?></div>
                </div>
                <div class="col-md-12">
                    <label for="input_clave" class="col-form-label"><?php echo $translations['html_observations']; ?></label>
                    
                    <textarea row="2" id="textarea_observaciones_cancelacion" class="form-control"></textarea>
                    <div class="invalid-feedback"><?php echo $translations['html_error_reason_cancellation']; ?></div>
                </div>
            </div>
            <div id="alert_error" class="alert alert-danger align-items-center" role="alert" style="display:none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img" aria-label="Warning:">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                <div id="msg_error">
                    
                </div>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal"><?php echo $translations['html_btn_cancel']; ?></button>
        <button type="button" id="btnSave" class="btn btn-primary"><?php echo $translations['html_btn_save']; ?></button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal_info_cita" tabindex="-1" aria-labelledby="label_modal_info_cita" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="label_modal_info_cita"><?php echo FuncionesGlobales::UpperString($translations['html_info_appointment']); ?></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body col-md-12">
        <form id="form_modal_cancelar_cita" class="needs-validation" novalidate>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label>Paciente: <span id="nombre_paciente"></span></label>
                </div>
                <div class="col-md-4">
                    <label>Profesional: <span id="nombre_profesional"></span></label>
                </div>
                <div class="col-md-4">
                    <label>Fecha: <span id="fecha_cita"></span></label>
                </div>
                <div class="col-md-4">
                    <label>Hora: <span id="hora_cita"></span></label>
                </div>
                <div class="col-md-4">
                    <label>Duraci&oacute;n: <span id="duracion"></span></label>
                </div>
                <div class="col-md-4">
                    <label>Usuario captura: <span id="usuario_captura"></span></label>
                </div>
                <div class="col-md-4">
                    <label>Asistencia: <span id="asistencia"></span></label>
                </div>
                <div class="col-md-4">
                    <label>Estatus: <span id="estatus"></span></label>
                </div>
                <div class="col-md-12 div_info_cancelacion hide">
                    <label>Informaci&oacute;n de la cancelaci&oacute;n de cita</label>
                    <div class="row">
                        <div class="col-md-4">
                            <label>Fecha: <span id="fecha_cancelacion"></span></label>
                        </div>
                        <div class="col-md-4">
                            <label>Usuario: <span id="usuario_cancelacion"></span></label>
                        </div>
                        <div class="col-md-4">
                            <label>Motivo: <span id="motivo_cancelacion"></span></label>
                        </div>
                        <div class="col-md-12">
                            <label>Observaciones: <span id="observaciones_cancelacion"></span></label>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 div_servicios">
                    <div class="col-md-12"><label>Lista de servicios</label></div>
                    <div class="d-flex border-bottom fw-bold py-2 mt-3">
                        <div class="flex-fill">Servicio</div>
                        <div class="flex-fill">Duración</div>
                        <div class="flex-fill">Costo</div>
                    </div>

                    <!-- Primera fila de datos -->
                    <div class="div_header_servicios">
                    </div>

                    <!-- Total -->
                    <div class="d-flex justify-content-end fw-bold py-2 mt-2">
                        <div>Total: $<span class="total"></span></div>
                    </div>
                </div>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal"><?php echo $translations['html_btn_cancel']; ?></button>
      </div>
    </div>
  </div>
</div>

<div id="template_servicio_cita_diaria" class=" py-2 border-bottom hide">
    <div class="flex-fill servicio">Lenguaje</div>
    <div class="flex-fill"><span class="duracion"></span> Min</div>
    <div class="flex-fill costo">$<span clas="costo"></span></div>
</div>

<script>
    let module_control_citas    = (function(){
        let draw            = 0;
        let count_hours     = 0;

        let estatus_asistencia  = {
            0   : 'FALTA',
            1   : 'ASISTENCIA',
            2   : 'RETARDO'
        };

        //  URL
        const controller    = '/Controlcitas';
        const url_index     = controller+"/index";

        //  language
        const translations  = {
            emptyTable: "<?= $translations['table_no_data'] ?>",
            info: "<?= $translations['showing_info'] ?>",
            infoEmpty: "<?= $translations['no_records'] ?>",
            search: "<?= $translations['search'] ?>",
            paginate: {
                first: "<?= $translations['paginate_first'] ?>",
                last: "<?= $translations['paginate_last'] ?>",
                next: "<?= $translations['paginate_next'] ?>",
                previous: "<?= $translations['paginate_previous'] ?>"
            },
            title_update    : "<?= $translations['html_edit_record'] ?>",
            title_delete    : "<?= $translations['html_delete_record'] ?>",
            title_preview   : "<?= $translations['html_preview_record'] ?>",
            title_change    : "<?= $translations['html_active_deactivate'] ?>",
            confirm_delete  : "<?= $translations['html_confirm_delete']?>",
            confirm_update  : "<?= $translations['html_confirm_update']?>",
            schedule_availability   : "<?= $translations['html_schedule_availability']?>",
            error_selected_location : "<?= $translations['error_selected_location']?>",
            error_professional      : "<?= $translations['html_error_professional']?>",
            error_selected_patient  : "<?= $translations['html_error_selected_patient']?>",
            error_starting_date     : "<?= $translations['html_error_starting_date']?>",
        };

        // Variable global para almacenar la instancia de DataTable
        let table;

        //  dias_programacion_citas
        const dias_programacion_citas = <?php echo $dias_programacion_citas; ?>

        // Función para inicializar o recargar la tabla
        // Función para inicializar o recargar la tabla
        function cargarTabla() {
            
            draw    ++;
            if (!table) {
                table = new DataTable('#table_results', {
                    dom: 'lrtip',
                    paging: true,
                    info: true,
                    lengthChange: false,
                    language: translations,
                    ordering: false,
                    serverSide: true,
                    ajax: {
                        url: url_index,
                        method: 'POST',
                        data: function (d) {
                            d.pageSize  = d.length == null || d.length == '' ? 1 : d.length;
                            d.offset    = d.start == null || d.start == '' ? 0 : d.start;
                            d.draw      = draw;
                            d.accion    = 'get_rows';
                            d.from_catalog      = true;
                            d.get_servicios     = true;
                            d.id_locacion       = $("#select_locaciones").val();
                            d.id_profesional    = $("#select_profesionales").val();
                            d.id_paciente       = $("#select_pacientes").val();
                            d.fecha_inicio      = $("#input_rango_fecha_inicio").val();
                            d.fecha_termino     = $("#input_rango_fecha_termino").val();
                            d.tipo_busqueda     = $('input[name="filtro_citas"]:checked').val() || 'todas'; // Obtiene el valor del radio seleccionado
                        }
                    },
                    columns: [
                        { data: 'nombre_completo' }, // Columna 1
                        { data: 'nombre_profesional' }, // Columna 1
                        { data: 'num_servicios' }, // Columna 1
                        { data: 'fecha_cita' }, // Columna 1
                        { data: 'hora_cita' }, // Columna 1
                        { data: 'estatus' }, // Columna 1
                        {
                            data: null, 
                            className: "text-center", // Centra el contenido de la celda
                            orderable: false, // Desactiva el ordenamiento para esta columna
                            render: function (data, type, row) {
                                draw    ++;
                                console.log('data',data);
                                // `data` contiene el objeto completo de la fila
                                // Generamos un botón con un atributo dinámico para identificar la fila

                                let btn_preview = 
                                '<button class="btn btn-outline-dark btn-sm btn_preview" data-id="'+data['id']+'" title="'+translations['title_preview'] +'">' +
                                    '<i class="bi bi-search"></i> '+
                                '</button>';

                                let btn_update  = 
                                '<button class="btn btn-outline-dark btn-sm btn_edit" data-id="'+data['id']+'" title="'+translations['title_update'] +'">' +
                                    '<i class="bi bi-pencil-fill"></i>'+
                                '</button>';

                                let btn_delete  = 
                                '<button class="btn btn-outline-dark btn-sm btn_cancelar" data-id="'+data['id_agenda_cita']+'" title="'+translations['title_delete'] +'">' +
                                    '<i class="bi bi-calendar-x"></i>'+
                                '</button>';
                                return btn_preview + btn_update + btn_delete;
                            }
                        }
                    ],
                    createdRow: function (row, data, dataIndex) {
                        // Guardar el objeto completo en la fila como data
                        $(row).data('rowData', data);
                        if (data.activa == 0) {
                            $(row).find('td:eq(5)').css('background-color', '#f85b4b'); // La sexta columna tiene índice 5
                        }

                        if (data.activa == 1) {
                            $(row).find('td:eq(5)').css('background-color', '#84e395'); // La sexta columna tiene índice 5
                        }
                    }
                });
            } else {
                draw    ++;
                table.ajax.reload();
            }
        }

        function show_modal_cancelar_cita(element){
            let modal_clone     = $("#modal_cancelar_cita").clone().removeAttr('id').show();
            let id_agenda_cita  = $(element).data('id');
            console.log('id_agenda_cita',id_agenda_cita);

            $(modal_clone).on('click','#btnSave',function(){
                let btn = $(this);
                $(btn).prop('disabled',true);
                const form = $(modal_clone).find('#form_modal_cancelar_cita')[0]; // Obtén el elemento DOM
                let flag_error  = false;
                if (form.checkValidity() === false) {
                    $(form).addClass('was-validated');
                    flag_error  = true;
                } else {
                    $(form).removeClass('was-validated');
                }

                if (flag_error){
                    $(btn).prop('disabled',false);
                    return false;
                }

                $.ajax({
                    url         : url_index,
                    method      : 'post',
                    dataType    : 'json',
                    data        : {
                        accion          : 'cancelar_cita',
                        id_motivo_cancelacion       : $(modal_clone).find("#select_motivo_cancelacion").val(),
                        observaciones_cancelacion   : $(modal_clone).find("#textarea_observaciones_cancelacion").val(),
                        id_agenda_cita              : $(element).data('id')
                    },
                    success     : function(data){
                        $(modal_clone).modal('hide');
                        showAlert('success','Cita cancelada');

                        $(modal_clone).find('#btnSave').prop('disabled',false);

                        if ("#input_rango_fecha_inicio" != null && $("#input_rango_fecha_inicio").val() != '' && $("#input_rango_fecha_termino").val() != null && $("#input_rango_fecha_termino").val() != ''){
                            cargarTabla();
                        }
                    },
                    error     : function(error){
                        console.log('error',error);
                        //$(modal_clone).find('#btnSave').prop('disabled',false);
                    }
                });
            });

            $(modal_clone).find('#select_motivo_cancelacion').select2({
                placeholder: 'Seleccione una opción',
                dropdownParent: $(modal_clone),
                width: '50px'
            });

            $(modal_clone).modal('show');
        }

        function fill_profesionales(id_locacion){
            $.ajax({
                url         : url_index,
                method      : 'post',
                data        : {
                    accion      : 'fill_profesionales',
                    id_locacion : id_locacion
                },
                success     : function(data){

                    $("#select_profesionales").val(null).trigger('change');
                    $("#select_profesionales").find('option').remove();

                    let options = '<option></option>';
                    for(let i in data){
                        options += '<option value="'+data[i]['id']+'">'+data[i]['nombre_completo']+'</option>';
                    }
                    
                    $("#select_profesionales").append(options);
                },
                error     : function(error){
                    $("#select_profesionales").val(null).trigger('change');
                    $("#select_profesionales").find('option').remove();
                    $("#select_profesionales").append('<option></option>');
                }
            })
        }

        function formatearFecha(fecha) {
            const opciones = { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit' };
            const fechaFormateada = fecha.toLocaleDateString('es-ES', opciones);
            const partes = fechaFormateada.split(', ');
            
            function capitalizarPrimeraLetra(texto) {
                return texto.charAt(0).toUpperCase() + texto.slice(1).toLowerCase();
            }

            if (partes.length > 1) {
                // Si la fecha incluye coma (formato "día, fecha")
                return capitalizarPrimeraLetra(partes[0]) + ', ' + partes[1];
            } else {
                // Si no hay coma, convertir la primera palabra (asumiendo que es el día)
                const palabras = fechaFormateada.split(' ');
                palabras[0] = capitalizarPrimeraLetra(palabras[0]);
                return palabras.join(' ');
            }
        }

        function formatearFechaExtensa(fechaStr) {
            if (!fechaStr) return '';

            // Separar fecha y hora
            const [fechaParte, horaParte] = fechaStr.split(' ');

            if (!fechaParte || !horaParte) return fechaStr; // Si no tiene formato esperado, devolver tal cual

            const [anio, mes, dia] = fechaParte.split('-');
            const [hora, minuto] = horaParte.split(':');

            // Retornar en formato más humano
            return `${dia}/${mes}/${anio} ${hora}:${minuto} hrs`;
        }


        function show_info_cita(info_cita){
            let modal_clone = $("#modal_info_cita").clone().show();
            $(modal_clone).find("#nombre_paciente").text(info_cita['nombre_completo']);
            $(modal_clone).find("#nombre_profesional").text(info_cita['nombre_profesional']);

            let split_today = info_cita['fecha_cita'].split('-');
            let fecha_cita  = new Date(parseInt(split_today[0]), parseInt(split_today[1]) - 1, parseInt(split_today[2]));

            $(modal_clone).find("#fecha_cita").text(formatearFecha(fecha_cita));
            $(modal_clone).find("#hora_cita").text(info_cita['hora_cita']);
            $(modal_clone).find("#duracion").text(info_cita['duracion']);
            $(modal_clone).find("#usuario_captura").text(info_cita['usuario_captura']);

            $(modal_clone).find("#asistencia").text(estatus_asistencia[info_cita['asistencia']]);
            $(modal_clone).find("#estatus").text(info_cita['estatus']);

            if (info_cita['activa'] != 1){
                $(modal_clone).find("#fecha_cancelacion").text(formatearFechaExtensa(info_cita['fecha_cancelacion']));
                $(modal_clone).find("#usuario_cancelacion").text(info_cita['usuario_cancelacion']);
                $(modal_clone).find("#motivo_cancelacion").text(info_cita['motivo_cancelacion']);
                $(modal_clone).find("#observaciones_cancelacion").text(info_cita['observaciones_cancelacion']);
                $(modal_clone).find('.div_info_cancelacion').removeClass('hide');
            }

            //  SE RECORREN LOS SERVICIOS
            for(let x in info_cita['servicios']){
                let servicio        = info_cita['servicios'][x];
                let row_servicio    = $("#template_servicio_cita_diaria").clone().removeAttr('id').addClass('d-flex').removeClass('hide');

                $(row_servicio).find('.servicio').text(servicio['nombre_servicio']);
                $(row_servicio).find('.duracion').text(servicio['duracion']);
                $(row_servicio).find('.costo').text(servicio['costo']);

                $(modal_clone).find('.div_header_servicios').append(row_servicio);
            }
            $(modal_clone).find('.total').text(info_cita['total']);
            $(modal_clone).modal('show');
        }

        $(document).ready(function() {

            $("#input_rango_fecha_inicio").val('2025-06-16');
            $("#input_rango_fecha_termino").val('2025-06-20');
            
            // Initialize the select elements
            $('.select_locaciones').select2({
                placeholder: translations['error_selected_location']
            });

            if ($("#select_locaciones").val() != null && $("#select_locaciones").val() != ''){
                fill_profesionales($("#select_locaciones").val());
            }

            $('.select_profesionales').select2({
                placeholder: translations['error_professional'],
                allowClear: true
            });

            $('#select_pacientes').select2({
                placeholder: translations['error_selected_patient'],
                width: '50px',
                minimumInputLength: 5,
                allowClear : true,
                ajax: {
                    url: url_index,
                    method: 'post',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        cadena_enviada  = params.term;
                        return {
                            accion: 'fill_combo',
                            cadena: params.term
                        };
                    },
                    processResults: function (data) {
                        // Aquí adaptamos la respuesta al formato que select2 necesita
                        return {
                            results: data.map(function (item) {
                                if (item.id == -1) return true;
                                return {
                                    id: item.id,
                                    text: item.celular + ' - ' + item.nombre_completo,
                                    nombre: item.nombre,
                                    primer_apellido: item.primer_apellido,
                                    segundo_apellido: item.segundo_apellido,
                                    celular: item.celular
                                };
                            })
                        };
                    },
                    cache: true
                }
            });

            // EVENTO PARA BUSCAR CITAS
            $('#btnBuscar').on('click', function() {
                if (($('#input_rango_fecha_inicio').val() == '' || $('#input_rango_fecha_inicio').val() == null) && ($('#input_rango_fecha_termino').val() == '' || $('#input_rango_fecha_termino').val() == null)) {
                    showAlert('danger', translations['error_starting_date']);
                    return false;
                }

                if ($('#input_rango_fecha_termino').val() == '') {
                    showAlert('danger', translations['error_starting_date']);
                    return false;
                }
                cargarTabla();
            });

            //  EVENTOS PARA APERTURA DE AGENDA
            $("#btn_agenda_opening").on('click',function(){
                let modal_clone = $("#modal_agenda_opening").clone().show();

                // Aplica select2 solo al nuevo select
                $(modal_clone).find('.select_locaciones_modal').select2({
                    placeholder : 'Seleccione una opción',
                    allowClear  : false,
                    dropdownParent: $(modal_clone),
                    width: '50px'
                }).on('select2:select',function(){
                    const id_locacion   = $(this).val();
                    $.ajax({
                        url     : url_index,
                        method  : 'post',
                        data    : {
                            accion      : 'get_date',
                            id_locacion : id_locacion
                        },
                        success     : function(data){
                            console.log('data');
                            console.log(data);

                            $(modal_clone).find('#input_fecha_inicio').prop('disabled',false).attr('min' , data['fecha_actual']).val(data['last_fecha_limite']).trigger('change');
                            $(modal_clone).find('#input_fecha_termino').attr('min' , data['fecha_actual']).prop('disabled',false);
                        },
                        error       : function(error){
                            actionJsonError(error,btn);
                        }
                    })
                });

                if ($(modal_clone).find('.select_locaciones_modal').val() != '' && $(modal_clone).find('.select_locaciones_modal') != null){
                    const id_locacion   = $(modal_clone).find('.select_locaciones_modal').val();
                    $.ajax({
                        url     : url_index,
                        method  : 'post',
                        data    : {
                            accion      : 'get_date',
                            id_locacion : id_locacion
                        },
                        success     : function(data){
                            console.log('data');
                            console.log(data);

                            $(modal_clone).find('#input_fecha_inicio').prop('disabled',false).attr('min' , data['fecha_actual']).val(data['last_fecha_limite']).trigger('change');
                            $(modal_clone).find('#input_fecha_termino').attr('min' , data['fecha_actual']).prop('disabled',false);
                        },
                        error       : function(error){
                            actionJsonError(error,btn);
                        }
                    })
                }

                $(modal_clone).on('change','#input_fecha_inicio',function(){
                    // Cadena de texto con la fecha en formato DD/MM/YYYY
                    const fechaStr = $(this).val();

                    // Dividir la cadena en día, mes y año
                    const [anio, mes, dia] = fechaStr.split('-');

                    // Crear un objeto Date (los meses en JavaScript son base 0, por eso restamos 1 al mes)
                    const fecha = new Date(anio, mes - 1, dia);

                    // Sumar 31 días
                    fecha.setDate(fecha.getDate() + parseInt(dias_programacion_citas));
                    let [nuevo_dia, nuevo_mes, nuevo_anio]  = fecha.toLocaleDateString().split('/');
                    nuevo_mes   = nuevo_mes.length == 1 ? '0'+nuevo_mes : nuevo_mes;
                    nuevo_dia   = nuevo_dia.length == 1 ? '0'+nuevo_dia : nuevo_dia;


                    // Mostrar la nueva fecha en formato local
                    $(modal_clone).find('#input_fecha_termino').val(nuevo_anio+'-'+nuevo_mes+'-'+nuevo_dia);
                });

                $(modal_clone).on('click','#btnSave',function(){
                    let btn =  $(this);
                    $(btn).prop('disable',true);

                    const form = $(modal_clone).find('#form_modal_agenda_opening')[0]; // Obtén el elemento DOM
                    let flag_error  = false;
                    if (form.checkValidity() === false) {
                        $(form).addClass('was-validated');
                        flag_error  = true;
                    } else {
                        $(form).removeClass('was-validated');
                    }

                    let fecha_inicio    = $(modal_clone).find('#input_fecha_inicio').val();
                    let fecha_termino   = $(modal_clone).find('#input_fecha_termino').val();

                    // Convertir las cadenas a objetos Date
                    fecha_inicio    = new Date(fecha_inicio);
                    fecha_termino   = new Date(fecha_termino);

                    //  VALIDAR REGISTROS
                    if (fecha_inicio > fecha_termino){
                        $(modal_clone).find('#alert_error').find('#msg_error').html(error_list['error_range_date']);
                        $(modal_clone).find('#alert_error').addClass('d-flex').show();
                        return false;
                    }

                    if(flag_error){
                        return false;
                    }

                    let obj_info    = {
                        id_locacion     : $(modal_clone).find('#select_locaciones_modal').val(),
                        nombre_locacion : $(modal_clone).find('#select_locaciones_modal').find('option:selected').text(),
                        fecha_inicio    : $(modal_clone).find('#input_fecha_inicio').val(),
                        fecha_termino   : $(modal_clone).find('#input_fecha_termino').val(),
                    };

                    console.log('obj_info');
                    console.log(obj_info);
                    //return false;

                    //  AJAX SAVE
                    $.ajax({
                        url         : url_index,
                        method      : 'POST',
                        dataType    : 'json',
                        data        : {
                            accion      : 'save_agenda_opening',
                            obj_info    : obj_info
                        },
                        success     : function(data){
                            $(btn).prop('disabled',false);
                            $(modal_clone).modal('hide');
                            showAlert('success',data);
                            if ("#input_rango_fecha_inicio" != null && $("#input_rango_fecha_inicio").val() != '' && $("#input_rango_fecha_termino").val() != null && $("#input_rango_fecha_termino").val() != ''){
                                cargarTabla();
                            }
                        },
                        error     : function(error){
                            actionJsonError(error,btn);
                        }
                    })
                });

                $(modal_clone).modal('show');
            });

            //  EVENTO PARA CANCELAR UNA CITA
            $("#table_results").on('click','.btn_cancelar',function(){
                show_modal_cancelar_cita($(this));
            });

            //  EVENTO PARA VISUALZAR LA INFORMACION DE LA CITA
            $("#table_results").on('click','.btn_preview',function(){
                // Obtener la fila padre
                let row = $(this).closest('tr');

                // Obtener los datos almacenados en la fila
                let data = row.data('rowData');

                console.log(data); // Aquí tienes todo el objeto data de esa fila
                show_info_cita(data);
            });
            
        });
        
    })();
</script>