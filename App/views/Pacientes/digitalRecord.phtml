<style>
    :root {
        --bs-body-bg-dark: #121212;
        --bs-tertiary-bg-dark: #1E1E1E;
    }
    
    #container_digital_record {
        font-family: 'Inter', sans-serif;
        overflow-x: hidden;
        width: 100%;
        max-width: 100%;
        position: relative;
    }
    
    #container_digital_record .sidebar {
        width: 220px;
        height: 100%;
        position: fixed;
        top: 0;
        z-index: 1000;
        transition: transform 0.3s ease;
    }
    
    #container_digital_record .nav-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 0.25rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    #container_digital_record .nav-link:hover {
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    #container_digital_record .nav-link.active {
        background-color: #0d6efd !important;
        color: white !important;
    }
    
    #container_digital_record .nav-link .material-icons {
        margin-right: 0.75rem;
        font-size: 1.2rem;
    }
    
    /* === CORRECCIÓN DEFINITIVA === */
    #container_digital_record .main-content {
        margin-left: 220px;
        width: calc(100% - 220px); /* ← KEY CHANGE */
        min-height: 100vh;
        max-width: calc(100% - 220px); /* ← KEY CHANGE */
        padding: 1rem;
        overflow-x: hidden;
        box-sizing: border-box;
    }
    
    #container_digital_record .sidebar-toggle {
        display: none;
    }
    
    /* Responsive Design
    @media (max-width: 992px) {
        #container_digital_record .sidebar {
            transform: translateX(-100%);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        #container_digital_record .sidebar.show {
            transform: translateX(0);
        }
        
        #container_digital_record .main-content {
            margin-left: 0;
            width: 100%;
            max-width: 100%;
            padding: 1rem;
            overflow-x: hidden;
            box-sizing: border-box;
        }
    }
    
    @media (max-width: 768px) {
        #container_digital_record .main-content {
            width: 100%;
            max-width: 100%;
            padding: 0.75rem;
            padding-top: 4rem;
            overflow-x: hidden;
            box-sizing: border-box;
        }
    } */
    
    /* Contenedor principal - MEJORADO */
    #container_digital_record .container-fluid {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
        overflow-x: hidden;
    }
    
    /* === NUEVAS REGLAS CRÍTICAS === */
    #container_digital_record .card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border-radius: 0.75rem;
        max-width: 100%;
        overflow: hidden;
    }
    
    #container_digital_record .card-body {
        padding: 1.5rem;
        overflow-x: hidden;
        max-width: 100%;
        width: 100%;
    }
    
    #container_digital_record .row {
        margin-left: 0;
        margin-right: 0;
        max-width: 100%;
        flex-wrap: wrap;
    }
    
    #container_digital_record [class*="col-"] {
        max-width: 100%;
        flex-shrink: 1;
        min-width: 0; /* ← CRÍTICO */
    }
    
    #container_digital_record .fw-medium {
        word-break: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
        overflow: hidden;
    }

    #container_digital_record .div_notas .card {
        min-height: 80vh; /* 80% del alto de la ventana */
    }

</style>
<?php 
//  FUNCIONES Y ARREGLOS PARA MOSTRAR DATOS GENERALES
$genero = array(
    'F'     => 'Femenino',
    'M'     => 'Masculino',
    null    => 'S/A'
);

$dias_semana = [
    1 => 'Lunes',
    2 => 'Martes',
    3 => 'Miércoles',
    4 => 'Jueves',
    5 => 'Viernes',
    6 => 'Sábado', 
    7 => 'Domingo'
];

?>

<div id="container_digital_record">
    <!-- Botón toggle para móvil -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <span class="material-icons">menu</span>
    </button>

    <!-- Overlay para móvil -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container-fluid p-0">
        <div class="row g-5">
            <!-- Sidebar -->
            <aside class="sidebar bg-white border-end d-flex flex-column" id="sidebar">
                <div class="p-3">
                    <div class="mb-4">
                        <h1 class="h5 fw-bold mb-1">Expediente Digital</h1>
                        <p class="small text-muted mb-0">Paciente: <?php echo $info_digital_record['info_paciente']['primer_apellido'].' '.$info_digital_record['info_paciente']['nombre']; ?></p>
                    </div>
                    
                    <nav class="nav flex-column nav-pills">
                        <a class="nav-link active bg-primary text-white" data-section="resumen">
                            <i class="bi bi-card-list"></i>
                            Resumen
                        </a>
                        <a class="nav-link text-dark" data-section="citas" style="display:none;">
                            <i class="bi bi-calendar"></i>
                            Citas
                        </a>
                        <a class="nav-link text-dark" data-section="documentos" style="display:none;">
                            <i class="bi bi-file"></i>
                            Documentos
                        </a>
                        <a class="nav-link text-dark" data-section="notas">
                            <i class="bi bi-journal"></i>
                            Notas
                        </a>
                    </nav>
                </div>
            </aside>

            <!-- Contenido principal -->
            <main class="main-content p-4 div_resumen">
                <div class="mb-4">
                    <h2 class="h3 fw-bold mb-1">Resumen del Expediente</h2>
                    <p class="text-muted mb-0">Datos personales y resumen de citas</p>
                </div>

                <!-- Información Personal -->
                <section class="mb-5">
                    <h3 class="h4 fw-semibold mb-3">Información Personal</h3>
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-sm-6 col-lg-4">
                                    <p class="small text-muted mb-1">Nombre completo</p>
                                    <p class="fw-medium mb-0"><?php echo $info_digital_record['info_paciente']['nombre_completo']; ?></p>
                                </div>
                                <div class="col-sm-6 col-lg-4">
                                    <p class="small text-muted mb-1">Fecha de Nacimiento</p>
                                    <p class="fw-medium mb-0"><?php echo $info_digital_record['info_paciente']['fecha_nacimiento']; ?></p>
                                </div>
                                <div class="col-sm-6 col-lg-4">
                                    <p class="small text-muted mb-1">Edad</p>
                                    <p class="fw-medium mb-0"><?php echo $info_digital_record['info_paciente']['edad_actual']; ?> años</p>
                                </div>
                                <div class="col-sm-6 col-lg-4">
                                    <p class="small text-muted mb-1">Género</p>
                                    <p class="fw-medium mb-0"><?php echo $genero[$info_digital_record['info_paciente']['genero']]; ?></p>
                                </div>
                                <div class="col-sm-6 col-lg-4">
                                    <p class="small text-muted mb-1">Teléfono</p>
                                    <p class="fw-medium mb-0"><?php echo $info_digital_record['info_paciente']['celular']; ?></p>
                                </div>
                                <div class="col-sm-6 col-lg-4">
                                    <p class="small text-muted mb-1">Correo Electrónico</p>
                                    <p class="fw-medium mb-0"><?php echo $info_digital_record['info_paciente']['correo_electronico']; ?></p>
                                </div>
                                <div class="col-12">
                                    <p class="small text-muted mb-1">Dirección</p>
                                    <p class="fw-medium mb-0"><?php echo $info_digital_record['info_paciente']['direccion']; ?></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Historial de Citas -->
                <section class="mb-5">
                    <h3 class="h4 fw-semibold mb-3">Citas programadas</h3>
                    <div class="card">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="p-3">D&iacute;a</th>
                                        <th class="p-3">Hora</th>
                                        <th class="p-3">Servicio</th>
                                        <th class="p-3">Profesional</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php $citas_programadas    = $info_digital_record['info_citas_programadas']; ?>
                                    <?php foreach($citas_programadas as $cita): ?>
                                    <tr>
                                        <td class="p-3"><?php echo $dias_semana[$cita['dia']]; ?></td>
                                        <td class="p-3"><?php echo $cita['hora_inicio'].' a '.$cita['hora_termino']; ?></td>
                                        <td class="p-3" style="background-color: <?php echo $cita['codigo_color']; ?>"><?php echo $cita['clave_servicio'] ?></td>
                                        <td class="p-3"><?php echo $cita['nombre_profesional'] ?></td>
                                    </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Diagnósticos y Tratamientos -->
                <section class="row g-4">
                    <div class="col-lg-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="h4 fw-semibold mb-0">Diagnósticos</h3>
                            <a class="btn btn-link text-primary text-decoration-none p-0" href="#">
                                Ver todos
                                <span class="material-icons" style="font-size: 1rem;">arrow_forward</span>
                            </a>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title h6 fw-semibold mb-3">Diagnóstico</h5>
                                <?php if (count($info_digital_record['diagnosticos']) > 0): ?>
                                <?php foreach($info_digital_record['diagnosticos'] as $diagnostico): ?>
                                <div class="border-start border-primary border-3 ps-3">
                                    <p class="fw-medium mb-1"><?php echo $diagnostico['nombre']; ?></p>
                                    <p class="small text-muted mb-0"><?php echo 'El paciente <b>'.($diagnostico['presento_evidencia'] == 1 ? 'SI' : 'NO').'</b> presento evidencia de este diagnostico.'; ?></p>
                                </div>
                                <?php endforeach; ?>
                                <?php else: ?>
                                <div class="border-start border-primary border-3 ps-3">
                                    <p class="fw-medium mb-1">Paciente sin diagnostico</p>
                                </div>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="h4 fw-semibold mb-0">Tratamientos</h3>
                            <a class="btn btn-link text-primary text-decoration-none p-0" href="#">
                                Ver todos
                                <span class="material-icons" style="font-size: 1rem;">arrow_forward</span>
                            </a>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title h6 fw-semibold mb-3">Tratamiento actual</h5>
                                <div class="border-start border-success border-3 ps-3">
                                    <p class="fw-medium mb-1">Sumatriptán 50mg</p>
                                    <p class="small text-muted mb-0">Tomar al inicio de la migraña, máximo 2 dosis al día.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
            <main class="main-content flex-grow-1 p-4 overflow-auto div_notas" style="display:none;">
                <div class="row g-4">
                    <!-- Añadir Nueva Nota -->
                    <section class="col-12 col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                            <h2 class="h4 fw-bold">Añadir Nueva Nota</h2>
                            <p class="text-muted small mb-0">Registre la evolución del paciente.</p>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary btn_expandir">
                            <span class="material-icons">fullscreen</span>
                            </button>
                        </div>
                        <form class="d-flex flex-column flex-grow-1">
                            <div class="flex-grow-1 mb-3">
                            <textarea class="form-control resizable-textarea" placeholder="Escriba aquí la nota de evolución del paciente..."></textarea>
                            </div>
                            <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="private-note"/>
                            <label for="private-note" class="form-check-label">Nota Privada (Solo visible para mí)</label>
                            </div>
                            <button type="submit" class="btn btn-info text-white fw-semibold">Añadir Nota</button>
                        </form>
                        </div>
                    </div>
                    </section>

                    <!-- Historial de Notas -->
                    <section class="col-12 col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                        <h2 class="h4 fw-bold mb-4">Historial de Notas</h2>
                        <div class="table-responsive">
                            <table class="table align-middle">
                            <thead class="table-light">
                                <tr>
                                <th scope="col">Fecha</th>
                                <th scope="col">Autor</th>
                                <th scope="col">Extracto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                <td>2024-07-29</td>
                                <td>
                                    <div class="d-flex align-items-center gap-1">
                                    Dra. Isabel Reyes
                                    <span class="material-icons text-warning" style="font-size:18px;">lock</span>
                                    </div>
                                </td>
                                <td class="text-muted">Paciente refiere mejoría en...</td>
                                </tr>
                                <tr>
                                <td>2024-07-15</td>
                                <td>Dr. Carlos Ponce</td>
                                <td class="text-muted">Se ajusta medicación para...</td>
                                </tr>
                                <tr>
                                <td>2024-07-01</td>
                                <td>Dra. Isabel Reyes</td>
                                <td class="text-muted">Evaluación inicial. Pacien...</td>
                                </tr>
                                <tr>
                                <td>2024-06-20</td>
                                <td>Dr. Alan Martinez</td>
                                <td class="text-muted">Resultados de laboratorio...</td>
                                </tr>
                            </tbody>
                            </table>
                        </div>
                        </div>
                    </div>
                    </section>
                </div>
                </main>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Funcionalidad del sidebar móvil
        function toggleSidebar() {
            $('#sidebar').toggleClass('show');
            $('#sidebarOverlay').toggleClass('show');
        }
        
        function closeSidebar() {
            $('#sidebar').removeClass('show');
            $('#sidebarOverlay').removeClass('show');
        }
        
        // Event listeners con jQuery
        $('#sidebarToggle').on('click', toggleSidebar);
        $('#sidebarOverlay').on('click', closeSidebar);
        
        // Navegación entre secciones
        $('#container_digital_record').on('click','.nav-link',function(e) {
            e.preventDefault();
            
            // Remover clase active de todos los enlaces
            $('#container_digital_record').find('.nav-link').removeClass('active bg-primary text-white').addClass('text-dark');
            
            // Añadir clase active al enlace clickeado
            $(this).removeClass('text-dark').addClass('active bg-primary text-white');

            $(".main-content").hide();
            $(".div_"+$(this).data('section')).show();
            
            // // Cerrar sidebar en móvil
            // if ($(window).width() < 992) {
            //     closeSidebar();
            // }
        });

        //  ------------------- NOTAS   ---------------------------------   //
        $(".btn_expandir").on("click", function(e) {
            e.preventDefault(); // opcional

            let $tabla = $("section:has(h2:contains('Historial de Notas')) table");
            let $nota = $("section:has(h2:contains('Añadir Nueva Nota'))");
            let $historial = $("section:has(h2:contains('Historial de Notas'))");
            let $icon = $(this).find("span.material-icons");

            // Si las columnas extra están visibles → ocultarlas y ajustar ancho
            if ($tabla.find("th:nth-child(n+3)").is(":visible")) {
                $tabla.find("th:nth-child(n+3), td:nth-child(n+3)").hide();

                // Expandir "Añadir Nota" y reducir "Historial de Notas"
                $nota.removeClass("col-lg-6").addClass("col-lg-8");
                $historial.removeClass("col-lg-6").addClass("col-lg-4");

                // Cambiar icono a "reducir"
                $icon.text("fullscreen_exit");
            } else {
                // Mostrar columnas extra de nuevo
                $tabla.find("th:nth-child(n+3), td:nth-child(n+3)").show();

                // Restaurar anchos originales
                $nota.removeClass("col-lg-8").addClass("col-lg-6");
                $historial.removeClass("col-lg-4").addClass("col-lg-6");

                // Cambiar icono a "expandir"
                $icon.text("fullscreen");
            }
        });


        
    });

</script>