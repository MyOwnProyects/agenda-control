<style>
    :root {
        --bs-body-bg-dark: #121212;
        --bs-tertiary-bg-dark: #1E1E1E;
    }
    
    #container_digital_record {
        font-family: 'Inter', sans-serif;
        overflow-x: hidden;
        width: 100%;
        max-width: 100%;
        position: relative;
    }
    
    #container_digital_record .sidebar {
        width: 220px;
        height: 100%;
        position: fixed;
        top: 0;
        z-index: 1000;
        transition: transform 0.3s ease;
    }
    
    #container_digital_record .nav-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 0.25rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    #container_digital_record .nav-link:hover {
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    #container_digital_record .nav-link.active {
        background-color: #0d6efd !important;
        color: white !important;
    }
    
    #container_digital_record .nav-link .material-icons {
        margin-right: 0.75rem;
        font-size: 1.2rem;
    }
    
    /* === CORRECCIÓN DEFINITIVA === */
    #container_digital_record .main-content {
        margin-left: 220px;
        width: calc(100% - 220px); /* ← KEY CHANGE */
        min-height: 100vh;
        max-width: calc(100% - 220px); /* ← KEY CHANGE */
        padding: 1rem;
        overflow-x: hidden;
        box-sizing: border-box;
    }
    
    #container_digital_record .sidebar-toggle {
        display: none;
    }
    
    /* Contenedor principal - MEJORADO */
    #container_digital_record .container-fluid {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
        overflow-x: hidden;
    }
    
    /* === NUEVAS REGLAS CRÍTICAS === */
    #container_digital_record .card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border-radius: 0.75rem;
        max-width: 100%;
        overflow: hidden;
    }
    
    #container_digital_record .card-body {
        padding: 1.5rem;
        overflow-x: hidden;
        max-width: 100%;
        width: 100%;
    }
    
    #container_digital_record .row {
        margin-left: 0;
        margin-right: 0;
        max-width: 100%;
        flex-wrap: wrap;
    }
    
    #container_digital_record [class*="col-"] {
        max-width: 100%;
        flex-shrink: 1;
        min-width: 0; /* ← CRÍTICO */
    }
    
    #container_digital_record .fw-medium {
        word-break: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
        overflow: hidden;
    }

    #container_digital_record .div_notas .card {
        min-height: 80vh; /* 80% del alto de la ventana */
    }

    .note-editable {
        height: calc(100vh - 200px) !important; /* Example: 100% of viewport height minus some offset */
        /* Or, if within a container: */
        /* height: 100% !important; */
    }

    .hide_element {
        display: none !important;
    }

    .row_selected{
        background-color: #3fd83fff;
    }

</style>
<?php 
//  FUNCIONES Y ARREGLOS PARA MOSTRAR DATOS GENERALES
$genero = array(
    'F'     => 'Femenino',
    'M'     => 'Masculino',
    null    => 'S/A'
);

$dias_semana = [
    1 => 'Lunes',
    2 => 'Martes',
    3 => 'Miércoles',
    4 => 'Jueves',
    5 => 'Viernes',
    6 => 'Sábado', 
    7 => 'Domingo'
];

function cambiarFormatoFecha($fecha) {
    return date('d/m/Y', strtotime($fecha));
}

?>

<div id="container_digital_record">
    <!-- Botón toggle para móvil -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <span class="material-icons">menu</span>
    </button>

    <!-- Overlay para móvil -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container-fluid p-0">
        <div class="row g-5">
            <!-- Sidebar -->
            <aside class="sidebar bg-white border-end d-flex flex-column" id="sidebar">
                <div class="p-3">
                    <div class="mb-4">
                        <h1 class="h5 fw-bold mb-1">Expediente Digital</h1>
                        <p class="small text-muted mb-0">Paciente: <?php echo $info_digital_record['info_paciente']['primer_apellido'].' '.$info_digital_record['info_paciente']['nombre']; ?></p>
                    </div>
                    
                    <nav class="nav flex-column nav-pills">
                        <a class="nav-link active bg-primary text-white" data-section="resumen">
                            <i class="bi bi-card-list"></i>
                            Resumen
                        </a>
                        <a class="nav-link text-dark" data-section="citas" style="display:none;">
                            <i class="bi bi-calendar"></i>
                            Citas
                        </a>
                        <a class="nav-link text-dark" data-section="documentos" style="display:none;">
                            <i class="bi bi-file"></i>
                            Documentos
                        </a>
                        <a class="nav-link text-dark" data-section="notas">
                            <i class="bi bi-journal"></i>
                            Notas
                        </a>
                    </nav>
                </div>
            </aside>

            <!-- Contenido principal -->
            <main class="main-content p-4 div_resumen">
                <div class="row g-2">
                    <div class="mb-4">
                        <h2 class="h3 fw-bold mb-1">Resumen del Expediente</h2>
                        <p class="text-muted mb-0">Datos personales y resumen de citas</p>
                    </div>

                    <!-- Información Personal -->
                    <section class="mb-5">
                        <h3 class="h4 fw-semibold mb-3">Información Personal</h3>
                        <div class="card">
                            <div class="card-body">
                                <form id="form_info_personal" class="needs-validation">
                                    <div class="row g-4">
                                        <div class="col-sm-6 col-lg-4">
                                            <p class="small text-muted mb-1">Primer apellido</p>
                                            <p class="fw-medium mb-0 p_datos"><?php echo $info_digital_record['info_paciente']['primer_apellido']; ?></p>
                                            <input type="text" class="input_editar_datos form-control input_primer_apellido hide_element" data-campo="primer_apellido" data-datooriginal="<?php echo $info_digital_record['info_paciente']['primer_apellido']; ?>" value="<?php echo $info_digital_record['info_paciente']['primer_apellido']; ?>" required />
                                            <div class="invalid-feedback">
                                                <?php echo $translations['html_error_first_lastname']; ?>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-3">
                                            <p class="small text-muted mb-1">Segundo apellido</p>
                                            <p class="fw-medium mb-0 p_datos"><?php echo $info_digital_record['info_paciente']['segundo_apellido']; ?></p>
                                            <input type="text" class="input_editar_datos form-control input_segundo_apellido hide_element" data-campo="segundo_apellido" data-datooriginal="<?php echo $info_digital_record['info_paciente']['segundo_apellido']; ?>" value="<?php echo $info_digital_record['info_paciente']['segundo_apellido']; ?>" />
                                        </div>
                                        <div class="col-sm-6 col-lg-4">
                                            <p class="small text-muted mb-1">Nombre</p>
                                            <p class="fw-medium mb-0 p_datos"><?php echo $info_digital_record['info_paciente']['nombre']; ?></p>
                                            <input type="text" class="input_editar_datos form-control input_nombre hide_element" data-campo="nombre" data-datooriginal="<?php echo $info_digital_record['info_paciente']['nombre']; ?>" value="<?php echo $info_digital_record['info_paciente']['nombre']; ?>" required/>
                                            <div class="invalid-feedback">
                                                <?php echo $translations['html_error_name']; ?>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-1">
                                            <div class="d-flex flex-column align-items-end gap-1">
                                                <?php if ($update): ?>
                                                <button type="button" class="btn btn-xs btn_edit_info_personal">
                                                    <i class="bi bi-pencil-fill"></i>
                                                </button>
                                                <button type="button" class="btn btn-xs btn_save_info_personal hide_element">
                                                    <i class="bi bi-floppy"></i>
                                                </button>
                                                <button type="button" class="btn btn-xs btn_revert_info_personal hide_element">
                                                    <i class="bi bi-arrow-counterclockwise"></i>
                                                </button>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-4">
                                            <p class="small text-muted mb-1">Fecha de Nacimiento</p>
                                            <p class="fw-medium mb-0 p_datos"><?php echo cambiarFormatoFecha($info_digital_record['info_paciente']['fecha_nacimiento']); ?></p>
                                            <input type="date" class="input_editar_datos form-control input_fecha_nacimiento hide_element" data-campo="fecha_nacimiento" data-datooriginal="<?php echo $info_digital_record['info_paciente']['fecha_nacimiento']; ?>" value="<?php echo $info_digital_record['info_paciente']['fecha_nacimiento']; ?>" />
                                            <div class="invalid-feedback">
                                                <?php echo $translations['html_error_cellphone']; ?>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-2">
                                            <p class="small text-muted mb-1">Edad</p>
                                            <p class="fw-medium mb-0"><?php echo $info_digital_record['info_paciente']['edad_actual']; ?> años</p>
                                        </div>
                                        <div class="col-sm-6 col-lg-3">
                                            <p class="small text-muted mb-1">Género</p>
                                            <p class="fw-medium mb-0 p_datos"><?php echo $genero[$info_digital_record['info_paciente']['genero']]; ?></p>
                                            <select class="form-select input_editar_datos select_genero hide_element" data-campo="genero" data-datooriginal="<?php echo $info_digital_record['info_paciente']['genero']; ?>">
                                                <option value="" <?php echo $genero[$info_digital_record['info_paciente']['genero']] == 'S/A' ? 'selected' : ''; ?>>Sin asignar</option>
                                                <option value="F" <?php echo $genero[$info_digital_record['info_paciente']['genero']] == 'Femenino' ? 'selected' : ''; ?>>Femenino</option>
                                                <option value="M" <?php echo $genero[$info_digital_record['info_paciente']['genero']] == 'Masculino' ? 'selected' : ''; ?>>Masculino</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                <?php echo $translations['html_error_cellphone']; ?>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-3">
                                            <p class="small text-muted mb-1">Teléfono</p>
                                            <p class="fw-medium mb-0 p_datos"><?php echo $info_digital_record['info_paciente']['celular']; ?></p>
                                            <input type="text" class="input_editar_datos input_celular form-control hide_element" maxLength="10" data-campo="celular" data-datooriginal="<?php echo $info_digital_record['info_paciente']['celular']; ?>" value="<?php echo $info_digital_record['info_paciente']['celular']; ?>" required/>
                                            <div class="invalid-feedback">
                                                <?php echo $translations['html_error_cellphone']; ?>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-4">
                                            <p class="small text-muted mb-1">Correo Electrónico</p>
                                            <p class="fw-medium mb-0 p_datos"><?php echo $info_digital_record['info_paciente']['correo_electronico'] == null ? 'S/A' : $info_digital_record['info_paciente']['correo_electronico']; ?></p>
                                            <input type="text" class="input_editar_datos input_correo_electronico form-control hide_element" data-campo="correo_electronico" data-datooriginal="<?php echo $info_digital_record['info_paciente']['correo_electronico']; ?>" value="<?php echo $info_digital_record['info_paciente']['correo_electronico']; ?>" />
                                            <div class="invalid-feedback">
                                                <?php echo $translations['html_error_email']; ?>
                                            </div>
                                        </div>
                                        <div class="col-8">
                                            <p class="small text-muted mb-1">Dirección</p>
                                            <p class="fw-medium mb-0 p_datos"><?php echo $info_digital_record['info_paciente']['direccion'] == null ? 'S/A' : $info_digital_record['info_paciente']['direccion']; ?></p>
                                            <input type="text" class="input_editar_datos form-control input_direccion hide_element" data-campo="direccion" data-datooriginal="<?php echo $info_digital_record['info_paciente']['direccion']; ?>" value="<?php echo $info_digital_record['info_paciente']['direccion']; ?>" />
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </section>

                    <!-- Historial de Citas -->
                    <section class="mb-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="h4 fw-semibold mb-0">Citas programadas</h3>
                            <?php if ($schedule_appointments): ?>
                            <a class="btn btn-link text-primary text-decoration-none p-0" href="/Pacientes/scheduleappointments?id=<?php echo $id_paciente; ?>">
                                Modificar registros
                                <span class="material-icons" style="font-size: 1rem;">arrow_forward</span>
                            </a>
                            <?php endif; ?>
                        </div>
                        <div class="card">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th class="p-3">D&iacute;a</th>
                                            <th class="p-3">Hora</th>
                                            <th class="p-3">Servicio</th>
                                            <th class="p-3">Profesional</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php $citas_programadas    = $info_digital_record['info_citas_programadas']; ?>
                                        <?php foreach($citas_programadas as $cita): ?>
                                        <tr>
                                            <td class="p-3"><?php echo $dias_semana[$cita['dia']]; ?></td>
                                            <td class="p-3"><?php echo $cita['hora_inicio'].' a '.$cita['hora_termino']; ?></td>
                                            <td class="p-3" style="background-color: <?php echo $cita['codigo_color']; ?>"><?php echo $cita['clave_servicio'] ?></td>
                                            <td class="p-3"><?php echo $cita['nombre_profesional'] ?></td>
                                        </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- Diagnósticos y Tratamientos -->
                    <section class="row g-4">
                        <div class="col-lg-6">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="h4 fw-semibold mb-0">Diagn&oacute;sticos</h3>
                                <?php if ($update): ?>
                                <a class="btn btn-link btn_diagnoses text-primary text-decoration-none p-0">
                                    Modificar diagn&oacute;stico
                                    <span class="material-icons" style="font-size: 1rem;">arrow_forward</span>
                                </a>
                                <?php endif; ?>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title h6 fw-semibold mb-3">Diagnóstico</h5>
                                    <?php if (count($info_digital_record['diagnosticos']) > 0): ?>
                                    <?php foreach($info_digital_record['diagnosticos'] as $diagnostico): ?>
                                    <div class="border-start border-primary border-3 ps-3">
                                        <p class="fw-medium mb-1"><?php echo $diagnostico['nombre']; ?></p>
                                        <p class="small text-muted mb-0"><?php echo 'El paciente <b>'.($diagnostico['presento_evidencia'] == 1 ? 'SI' : 'NO').'</b> presento evidencia de este diagnostico.'; ?></p>
                                    </div>
                                    <?php endforeach; ?>
                                    <?php else: ?>
                                    <div class="border-start border-primary border-3 ps-3">
                                        <p class="fw-medium mb-1">Paciente sin diagnostico</p>
                                    </div>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="h4 fw-semibold mb-0">Tratamiento</h3>
                                <?php if ($update): ?>
                                <a class="btn btn-link btn_diagnoses text-primary text-decoration-none p-0">
                                    Modificar diagn&oacute;stico
                                    <span class="material-icons" style="font-size: 1rem;">arrow_forward</span>
                                </a>
                                <?php endif; ?>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title h6 fw-semibold mb-3">Tratamiento actual</h5>
                                    <div class="border-start border-success border-3 ps-3">
                                        <p class="fw-medium mb-1">Sumatriptán 50mg</p>
                                        <p class="small text-muted mb-0">Tomar al inicio de la migraña, máximo 2 dosis al día.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
            <main class="main-content flex-grow-1 p-4 overflow-auto div_notas" style="display:none;">
                <div class="row g-2">
                    <div class="mb-4">
                        <h2 class="h3 fw-bold mb-1">Notas</h2>
                        <p class="text-muted mb-0">Notas privadas y compartidas</p>
                    </div>
                    <!-- Añadir Nueva Nota -->
                    <section class="col-12 col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h2 class="h4 fw-bold">Añadir Nueva Nota</h2>
                                <p class="text-muted small mb-0">Registre la evolución del paciente.</p>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary btn_expandir">
                                <span class="material-icons">fullscreen</span>
                            </button>
                        </div>
                        <div class="row div_titulo mb-3">
                            <label>Titulo</label>
                            <input type="text" class="form-control input_titulo_nota" />
                        </div>
                        <form class="d-flex flex-column flex-grow-1">
                            <div class="flex-grow-1 mb-3">
                            <div id="summernote"></div>
                            </div>
                            <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="private-note"/>
                            <label for="private-note" class="form-check-label">Nota Privada (Solo visible para mí)</label>
                            </div>
                            <button type="button" class="btn btn-info text-white fw-semibold btn_save_nota">Añadir Nota</button>
                            
                        </form>
                        <!-- Contenedor para los botones alineados a la derecha -->
                        <div class="d-flex justify-content-end align-items-center gap-2 mt-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary btn_edit_nota btn_cancelar_edit" style="display:none;">Cancelar</button>
                            <button type="button" class="btn btn-sm btn-success btn_edit_nota text-white btn_save_nota" style="display:none;">Guardar</button>
                        </div>
                        </div>
                    </div>
                    </section>

                    <!-- Historial de Notas -->
                    <section class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h2 class="h4 fw-bold mb-4">Historial de Notas</h2>
                                <table id="table_results" class="display table table-hover table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th><?php echo $translations['html_title']; ?></th>
                                            <th><?php echo $translations['html_title_professional']; ?></th>
                                            <th><?php echo $translations['html_creation_date']; ?></th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>
                </main>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_diagnostico" tabindex="-1" aria-labelledby="label_modal_diagnostico" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="label_modal_diagnostico">Captura de diagnostico(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body col-md-12">
        <form id="form_modal_create" class="needs-validation" novalidate>
            <div class="row mb-3">            
                <!-- Campo Clave -->
                <div class="col-md-12">
                    <label><?php echo $translations['html_title_patient']; ?>:</label>
                    <div id="nombre_paciente" class="d-block"></div>
                </div>
                <!-- Campo Nombre -->
                <div class="col-md-12">
                    <label for="input_diagnoses" class="col-form-label"><?php echo $translations['html_registered_diagnoses']; ?></label>
                </div>
                <div class="div_lista_diagnosticos col-md-12">
                    <div class="row">
                        <div class="col-md-2"><?php echo $translations['html_abrev']; ?></div>
                        <div class="col-md-8"><?php echo $translations['html_diagnoses']; ?></div>
                        <div class="col-md-2"><?php echo $translations['html_evidence']; ?></div>
                    </div>
                    
                    <?php foreach($arr_transtornos as $row): ?>
                        <div data-id="<?php echo $row['id']; ?>" class="row div_diagnostico" id="diagnostico_<?php echo $row['id']; ?>">
                            <div class="col-md-2"><?php echo ($row['clave']); ?></div>
                            <div class="col-md-8"><?php echo ($row['nombre']); ?></div>
                            <div class="col-md-2" align="center"><input type="checkbox" class="input_evidencia"  disabled/></div>
                        </div>
                    <?php endforeach; ?>
                </div>
            
                <div id="alert_error" class="alert alert-danger align-items-center" role="alert" style="display:none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img" aria-label="Warning:">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                    </svg>
                <div id="msg_error">
                    
                </div>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal"><?php echo $translations['html_btn_cancel']; ?></button>
        <button type="button" id="btnSave" class="btn btn-primary"><?php echo $translations['html_btn_save']; ?></button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal_preview_nota" tabindex="-1" aria-labelledby="label_modal_preview_nota" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h3 class="modal-title" id="label_modal_diagnostico">Nota</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body col-md-12">
        <form id="form_modal_create" class="needs-validation" novalidate>
            <div class="row mb-3">            
                <!-- Campo Clave -->
                <div class="col-md-12">
                    <label><?php echo $translations['html_title_professional']; ?>:</label>
                    <div id="nombre_profesional" class="d-block"></div>
                </div>
                <div class="col-md-12">
                    <label><?php echo $translations['html_title']; ?>:</label>
                    <div id="titulo" class="d-block"></div>
                </div>
                <!-- Campo Nombre -->
                <div class="col-md-12 div_show_nota" style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ccc; border-radius: 4px; background: white; overflow-y: auto; overflow-x: auto;">
                    
                </div>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal"><?php echo $translations['html_btn_cancel']; ?></button>
        <button type="button" id="btn_delete" class="btn btn-danger" ><?php echo $translations['html_delete_record']; ?></button>
        <button type="button" id="btn_edit" class="btn btn-success"><?php echo $translations['html_edit_record']; ?></button>
      </div>
    </div>
  </div>
</div>

<script>
    let modulo_digital_record   = (function(){
        //  ID DEL PACIENTE
        const id_paciente   = '<?php echo $id_paciente; ?>';
        const estatus       = '<?php echo $info_digital_record['info_paciente']['estatus']; ?>';
        const nombre_completo   = '<?php echo $info_digital_record['info_paciente']['nombre_completo']; ?>';
        let diagnosticos        = '<?php echo $diagnosticos ?>';
        diagnosticos            = JSON.parse(diagnosticos);

        //  URL
        const controller    = '/Pacientes';
        const url_digital   = controller+'/digitalRecord'
        const url_update    = controller+"/update";

        // Variable global para almacenar la instancia de DataTable
        let table;
        let draw            = 1;

        const translations  = {
            emptyTable: "<?= $translations['table_no_data'] ?>",
            info: "<?= $translations['showing_info'] ?>",
            infoEmpty: "<?= $translations['no_records'] ?>",
            search: "<?= $translations['search'] ?>",
            paginate: {
                first: "<?= $translations['paginate_first'] ?>",
                last: "<?= $translations['paginate_last'] ?>",
                next: "<?= $translations['paginate_next'] ?>",
                previous: "<?= $translations['paginate_previous'] ?>"
            },
            title_update    : "<?= $translations['html_edit_record'] ?>",
            title_delete    : "<?= $translations['html_delete_record'] ?>",
            title_preview   : "<?= $translations['html_preview_record'] ?>",
            title_change    : "<?= $translations['html_active_deactivate'] ?>",
            confirm_delete  : "<?= $translations['html_confirm_delete']?>",
            deactivate_patient      : "<?= $translations['html_deactivate_patient']?>",
            activate_patient        : "<?= $translations['html_activate_patient']?>",
            schedule_appointments   : "<?= $translations['html_schedule_appointments']?>",
            monday: "<?php echo $translations['html_monday'];     ?>",
            thuesday: "<?php echo $translations['html_thuesday'];   ?>",
            wednesday: "<?php echo $translations['html_wednesday'];  ?>",
            thursday: "<?php echo $translations['html_thursday'];   ?>",
            friday: "<?php echo $translations['html_friday'];     ?>",
            saturday: "<?php echo $translations['html_saturday'];   ?>",     
            diagnosis_capture   :  "<?php echo $translations['html_diagnosis_capture'];   ?>",
            digital_record      :  "<?php echo $translations['html_digital_record'];   ?>",
        };

        //  MENSAJES DE ERROR
        const error_list = {
            sin_permisos    : "<?php echo $translations['html_error_empty_list']; ?>",
            error_email     : "<?php echo $translations['html_error_email']; ?>",
            error_celular   : "<?php echo $translations['html_error_cellphone']; ?>",
            error_contrasena    : "<?php echo $translations['html_error_different_password']; ?>",
            error_length_contrasena     : "<?php echo $translations['html_error_length_password']; ?>",
            error_validate_cellphone    : "<?php echo $translations['html_error_validate_cellphone']; ?>",
            error_verify_general_data   : "<?php echo $translations['html_error_verify_general_data']; ?>",
            error_verify_cellphone_user : "<?php echo $translations['html_error_verify_cellphone_user']; ?>",
            question_return             : "<?php echo $translations['html_question_return']?>",
        }

        // Función para inicializar o recargar la tabla
        function cargarTabla() {
            draw    ++;
            if (!table) {
                table = new DataTable('#table_results', {
                    dom: 'lrtip',
                    paging: true,
                    info: true,
                    lengthChange: false,
                    language: translations,
                    ordering: false,
                    serverSide: true,
                    ajax: {
                        url: url_digital,
                        method: 'POST',
                        data: function (d) {
                            d.pageSize  = d.length == null || d.length == '' ? 1 : d.length;
                            d.offset    = d.start == null || d.start == '' ? 0 : d.start;
                            d.draw      = draw;
                            d.accion    = 'get_notes';
                            d.id_paciente   = id_paciente;
                        },
                        dataSrc: function (json) {
                            console.log("DataTables Response:", json); // <---- Depuración
                            return json.data;
                        }
                    },
                    columns: [
                        { data: 'titulo' },
                        { data: 'nombre_profesional' }, // Columna 1
                        { data: 'label_fecha_creacion' } // Columna 1
                    ],
                    createdRow: function (row, data, dataIndex) {
                        // Guardar el objeto completo en la fila como data
                        $(row).data('rowData', data);
                        $(row).css('cursor','pointer');
                        $(row).addClass('row_notas');
                    }
                });
            } else {
                draw    ++;
                table.ajax.reload();
            }
        }

        $(document).ready(function() {
            cargarTabla();

            //  CREAR SUMMERNOTE
            $('#summernote').summernote({
                lang: 'es-ES',
                placeholder: 'Escribe tu nota aquí...',
                tabsize: 2,
                height: 100,
                toolbar: [
                    // Grupo más básico y funcional
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['fontsize', ['fontsize']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']]
                ],
                disableResizeEditor: true,
                callbacks: {
                    onPaste: function(e) {
                        // Limpiar contenido pegado
                        var bufferText = ((e.originalEvent || e).clipboardData || window.clipboardData).getData('Text');
                        e.preventDefault();
                        document.execCommand('insertText', false, bufferText);
                    }
                }
            });
            
            
            // Navegación entre secciones
            $('#container_digital_record').on('click','.nav-link',function(e) {
                e.preventDefault();
                
                // Remover clase active de todos los enlaces
                $('#container_digital_record').find('.nav-link').removeClass('active bg-primary text-white').addClass('text-dark');
                
                // Añadir clase active al enlace clickeado
                $(this).removeClass('text-dark').addClass('active bg-primary text-white');

                $(".main-content").hide();
                $(".div_"+$(this).data('section')).show();
                
                // // Cerrar sidebar en móvil
                // if ($(window).width() < 992) {
                //     closeSidebar();
                // }
            });

            //  ------------------- INFORMACION PERSONAL    ----------------    //

            $(".btn_edit_info_personal").on('click',function(){
                $(".btn_edit_info_personal").addClass('hide_element');
                $(".btn_save_info_personal").removeClass('hide_element');
                $(".btn_revert_info_personal").removeClass('hide_element');

                $(".input_editar_datos").removeClass('hide_element');
                $(".p_datos").addClass('hide_element');
            });

            $(".btn_revert_info_personal").on('click',function(){
                $(".btn_edit_info_personal").removeClass('hide_element');
                $(".btn_save_info_personal").addClass('hide_element');
                $(".btn_revert_info_personal").addClass('hide_element');

                $(".input_editar_datos").addClass('hide_element');
                $(".p_datos").removeClass('hide_element');
            });

            $(".btn_save_info_personal").on('click', function(){
                const form = $('#form_info_personal')[0];
                let flag_error = false;
                
                if (form.checkValidity() === false) {
                    $(form).addClass('was-validated');
                    flag_error = true;
                } else {
                    $(form).removeClass('was-validated');
                    // Proceder con el guardado
                }
                
                //  VALIDACION DE DATOS
                if ($('.input_celular').val() != '' && $('.input_celular').val().length != 10){
                    //  ACTIVAR DE FORMA MANUAL ERROR DE FORM
                    $('.input_celular')[0].setCustomValidity(error_list['error_celular']);
                    $('.input_celular').addClass('is-invalid').removeClass('is-valid');
                    return false;
                } else {
                    //REMOVER CLASE DE ERROR FORM
                    $('.input_celular')[0].setCustomValidity('');
                    $('.input_celular').removeClass('is-invalid');
                }

                if ($('.input_correo_electronico').val() != '' && !validarEmail($('.input_correo_electronico').val())){
                    $('.input_correo_electronico')[0].setCustomValidity(error_list['error_email']);
                    $('.input_correo_electronico').addClass('is-invalid').removeClass('is-valid');
                    return false;
                } else {
                    $('.input_correo_electronico')[0].setCustomValidity('');
                    $('.input_correo_electronico').removeClass('is-invalid');
                }

                let obj_info    = {
                    id                  : id_paciente,
                    primer_apellido     : $(".input_primer_apellido").val(),
                    segundo_apellido    : $(".input_segundo_apellido").val(),
                    nombre              : $(".input_nombre").val(),
                    fecha_nacimiento    : $(".input_fecha_nacimiento").val(),
                    genero              : $(".select_genero").val(),
                    celular             : $(".input_celular").val(),
                    correo_electronico  : $(".input_correo_electronico").val(),
                    direccion           : $(".input_direccion").val()
                };

                $.ajax({
                    url     : url_update,
                    method  : 'post',
                    data    : {
                        obj_info    : obj_info,
                        accion      : 'save_express'
                    },
                    success : function(data){
                        showAlert('success','Edición exitosa!');
                        setTimeout(function(){
                            window.location.href = '/Pacientes/digitalRecord?id='+id_paciente+'&r='+Math.floor(Math.random() * 1000);
                        },2000);
                    },
                    error   : function(error){
                        showAlert('danger',error.responseText);
                    }
                })
            });

            //  EVENTO PARA MODOFICAR DIAGNOSTICO
            $(".btn_diagnoses").on('click',function(){
                if (estatus != 1){
                    showAlert('danger','El paciente no puede modificarse hasta que este en estatus ACTIVO');
                    return false;
                }
                show_modal_diagnoses();
            });

            //  EVENTOS PARA CONTROLAR LOS DATOS A INGRESAR
            $("#form_info_personal").on('keypress','.input_celular',function(e) {
                if(isNaN(this.value + String.fromCharCode(e.charCode))) 
                return false;
            })
            .on("cut copy paste",function(e){
                e.preventDefault();
            });

            //  ------------------- NOTAS   ---------------------------------   //
            $(".btn_expandir").on("click", function(e) {
                e.preventDefault();

                let $tabla = $("section:has(h2:contains('Historial de Notas')) table");
                let $nota = $("section:has(h2:contains('Añadir Nueva Nota'))");
                let $historial = $("section:has(h2:contains('Historial de Notas'))");
                let $icon = $(this).find("span.material-icons");

                // Obtener la instancia de DataTable
                let dataTable = $('#table_results').DataTable();

                // Verificar si la columna 2 (índice 2) está visible
                if (dataTable.column(2).visible()) {
                    // Ocultar columna 2 (tercera columna)
                    dataTable.column(2).visible(false);

                    // Expandir "Añadir Nota" y reducir "Historial de Notas"
                    $nota.removeClass("col-lg-6").addClass("col-lg-8");
                    $historial.removeClass("col-lg-6").addClass("col-lg-4");

                    // Cambiar icono a "reducir"
                    $icon.text("fullscreen_exit");
                } else {
                    // Mostrar columna 2 (tercera columna)
                    dataTable.column(2).visible(true);

                    // Restaurar anchos originales
                    $nota.removeClass("col-lg-8").addClass("col-lg-6");
                    $historial.removeClass("col-lg-4").addClass("col-lg-6");

                    // Cambiar icono a "expandir"
                    $icon.text("fullscreen");
                }
            });

            //  GUARDAR UNA NOTA
            $(".btn_save_nota").on('click',function(){
                if ($(".input_titulo_nota").val().trim() == null || $(".input_titulo_nota").val().trim() == ''){
                    showAlert('danger','Ingrese el titulo de la nota');
                    return false;
                }

                if ($('#summernote').summernote('isEmpty')) {
                    showAlert('danger','Ingresa un contenido a la nota');
                    return false;
                }

                // Get the formatted HTML first
                var htmlContent = $('#summernote').summernote('code');

                let id_nota = $(this).data('idnota');
                let accion  = id_nota != null && id_nota != '' ? 'update_note' : 'create_note';

                $.ajax({
                    url     : url_digital,
                    method  : 'post',
                    data    : {
                        accion      : accion,
                        titulo      : $(".input_titulo_nota").val().trim(),
                        id_paciente : id_paciente,
                        texto       : htmlContent,
                        nombre_completo : nombre_completo,
                        nota_privada    : $("#private-note").is(':checked') ? 1 : 0,
                        id_nota         : id_nota
                    },
                    success : function(data){
                        showAlert('success','Captura exitosa!');
                        $(".input_titulo_nota").val('');
                        $('#summernote').summernote('code', '');
                        $("#private-note").prop('checked',0);

                        cargarTabla();
                    },
                    error   : function(error){
                        showAlert('danger',error.responseText);
                    }
                })

            });

            //  CANCELAR EDICION
            $(".btn_cancelar_edit").on('click',async function(){
                const respuesta = await window.modalConfirm('Iniciaste la edici&oacute;n de una nota, al continuar se perderá el avance de dicha nota. ¿Desea continuar?');

                if (respuesta){
                    $(".input_titulo_nota").val('');
                    $('#summernote').summernote('code', '');
                    $("#private-note").prop('checked',0);

                    $(".btn_edit_nota").hide();
                    $(".btn_save_nota").show();
                }
            });

            //  GET INFO DE UNA NOTA
            $(".div_notas").on('click','.row_notas',function(){
                let row_data    = $(this).data('rowData');
                $.ajax({
                    url     : url_digital,
                    method  : 'post',
                    data    : {
                        accion  : 'get_notes',
                        id_nota : row_data['id'],
                        nombre_completo : nombre_completo
                    },
                    success : function(data){
                        show_modal_notas(data['data'][0]);
                    },
                    error   : function(error){
                        showAlert('danger',error.responseText);
                        return false;
                    }
                })
            });


            //  --------------  FUNCIONES   ---------------------   //

            //  MODAL PARA CAPTURA Y EDICION DE DIAGNOSTICOS
            function show_modal_diagnoses(){
                let modal_clone = $("#modal_diagnostico").clone().removeAttr('id');

                if (diagnosticos != null && Object.keys(diagnosticos).length > 0){
                    for(let i in diagnosticos){
                        $(modal_clone).find('#diagnostico_'+diagnosticos[i]['id'])
                            .addClass('row_selected')
                            .find('.input_evidencia')
                            .prop('disabled',false)
                            .prop('checked',diagnosticos[i]['presento_evidencia'] == 1 ? true : false);
                    }
                }

                $(modal_clone).find('#nombre_paciente').text(nombre_completo);

                $(modal_clone).on('click','.div_diagnostico',function(event){
                    // Evita que el evento se dispare si el clic fue en el input
                    if ($(event.target).is('input')) {
                        return;
                    }
                    if ($(this).hasClass('row_selected')){
                        $(this).removeClass('row_selected');
                        $(this).find('input').prop('disabled',true).prop('checked',false)
                    } else {
                        $(this).addClass('row_selected');
                        $(this).find('input').prop('disabled',false);
                    }
                });
                
                $(modal_clone).on('click','#btnSave',function(){
                    let btn         = $(this);
                    $(btn).prop('disabled',true);

                    let obj_info    = [];

                    $(modal_clone).find('.div_diagnostico.row_selected').each(function(){
                        let id_transtorno       = $(this).data('id');
                        let presento_evidencia  = $(this).find('input').prop('checked') ? 1 : 0;
                        obj_info.push({
                            id_transtorno,
                            presento_evidencia
                        })
                    });

                    console.log('obj_info',obj_info);

                    $.ajax({
                        url     : url_update,
                        method  : 'post',
                        data    : {
                            accion      : 'save_diagnoses',
                            obj_info    : obj_info,
                            id_paciente : id_paciente,
                            data_old    : diagnosticos
                        },
                        success : function(data){
                            showAlert('success','Captura exitosa!');
                            $(modal_clone).modal('hide');
                            setTimeout(function(){
                                window.location.href = '/Pacientes/digitalRecord?id='+id_paciente+'&r='+Math.floor(Math.random() * 1000);
                            },2000);
                        },
                        error   : function(error){
                            actionJsonError(error,btn);
                        }
                    });
                })

                $(modal_clone).modal('show');
            }

            function show_modal_notas(data){
                console.log('data',data);
                let modal_clone = $("#modal_preview_nota").clone().removeAttr('id').show();

                $(modal_clone).find("#nombre_profesional").text(data['nombre_profesional']);
                $(modal_clone).find("#titulo").text(data['titulo']);
                $(modal_clone).find(".div_show_nota").html(data['texto']);

                $(modal_clone).on('click','#btn_edit',async function(){
                    if ($(".input_titulo_nota").val().trim() != '' || !$('#summernote').summernote('isEmpty')){
                        const respuesta = await window.modalConfirm('Iniciaste la creación de una nota, al continuar se perderá el avance de dicha nota. ¿Desea continuar?');

                        if (!respuesta){
                            return false;
                        }
                    }

                    $(".input_titulo_nota").val(data['titulo']);
                    $("#private-note").prop('checked',data['nota_privada'] == 1);
                    $('#summernote').summernote('code', '');
                    $('#summernote').summernote('code', data['texto']);
                    $(".btn_save_nota").hide();
                    $(".btn_edit_nota").data('idnota',data['id']).show();

                    $(modal_clone).modal('hide');
                });

                $(modal_clone).on('click','#btn_delete', async function(){
                    const respuesta = await window.modalConfirm(translations['confirm_delete']);

                    if (respuesta){
                        $.ajax({
                            url     : url_digital,
                            method  : 'post',
                            data    : {
                                accion  : 'delete_note',
                                id_nota : data['id'],
                                titulo  : data['titulo'],
                                fecha_creacion  : data['fecha_creacion'],
                                nombre_completo : nombre_completo
                            },
                            success : function(data){
                                showAlert('success','Borrado exitoso!');
                                $(modal_clone).modal('hide');
                                cargarTabla();
                            },
                            error   : function(error){
                                showAlert('danger',error.responseText);
                            }
                        })
                    }
                });

                $(modal_clone).modal('show');
            }
            
        });
    })();
</script>